@page
@model IndexModel
@{
	ViewData["Title"] = "Home page";
}

<div x-show="tab == 'recipes'">
	<div class="container d-flex justify-content-between align-items-center my-4">
		<h2>All Recipes</h2>
		<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createRecipeModal">
			Add a Recipe
		</button>
	</div>

	@* Recipe Cards *@
	<div x-data="{recipes: {}}"
		 x-effect="recipes = await $store.recipes;"
		 x-cloak
		 class="row row-cols-sm-1 row-cols-xl-2 g-4 pb-5">
		<template x-for="recipe in recipes">
			<div class="col">
				<div class="card">
					<div class="card-body">

						<h5 class="card-title text-center" x-text="recipe.title"></h5>

						<template x-for="category in recipe.categories">
							<span class="badge bg-success mb-2 mx-1" x-text="category"></span>
						</template>

						<div class="accordion">

							@* Ingredients *@
							<div class="accordion-item" x-data x-id="['Ingredients' + recipe.id]">
								<h2 class="accordion-header">
									<button x-data class="accordion-button collapsed" type="button" data-bs-toggle="collapse" :data-bs-target="'#' + $id('Ingredients' + recipe.id)" aria-expanded="true" :aria-controls="$id('Ingredients' + recipe.id)">
										Ingredients
									</button>
								</h2>
								<div x-data :id="$id('Ingredients' + recipe.id)" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne">
									<div class="accordion-body">
										<ul>
											<template x-for="ingredient in recipe.ingredients">

												<li x-text="ingredient"></li>

											</template>
										</ul>
									</div>
								</div>
							</div>

							@* Instructions *@
							<div class="accordion-item" x-data x-id="['Instructions' + recipe.id]">
								<h2 class="accordion-header">
									<button x-data class="accordion-button collapsed" type="button" data-bs-toggle="collapse" :data-bs-target="'#' + $id('Instructions' + recipe.id)" aria-expanded="true" :aria-controls="$id('Instructions' + recipe.id)">
										Instructions
									</button>
								</h2>
								<div x-data :id="$id('Instructions' + recipe.id)" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingOne">
									<div class="accordion-body">
										<ul>
											<template x-for="instruction in recipe.instructions">

												<li x-text="instruction"></li>

											</template>
										</ul>
									</div>
								</div>
							</div>

						</div>

						@* Buttons *@
						<div class="text-center mt-3">
							<div class="btn-group">
								<button class="btn btn-primary" data-bs-toggle="modal" :data-bs-target="'#editRecipeModal' + recipe.id">
									<i class="bi bi-pencil-square"></i>
								</button>
								<button class="btn btn-danger" data-bs-toggle="modal" :data-bs-target="'#DeleteModal' + recipe.id">
									<i class="bi bi-trash"></i>
								</button>
							</div>
						</div>

						@* Delete Modal *@
						<div class="modal fade" :id=" 'DeleteModal'+recipe.id " tabindex="-1">
							<div class="modal-dialog">
								<div class="modal-content text-center">
									<form x-on:submit.prevent="await deleteRecipe(recipe); $store.recipes = await getRecipes();">
										<div class="modal-header">
											<h5 class="modal-title">Are you sure you want to delete this recipe?</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">
											<dl class="row">
												<dt>
													Title
												</dt>
												<dd x-html="recipe.title">
												</dd>
											</dl>
										</div>
										<div class="modal-footer">
											<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
											<button type="submit" class="btn btn-danger" data-bs-dismiss="modal">Delete Recipe</button>
										</div>
									</form>
								</div>
							</div>
						</div>

						@* Edit Recipe Modal *@
						<div class="modal fade" :id="'editRecipeModal'+recipe.id" tabindex="-1">
							<div class="modal-dialog modal-lg">
								<div class="modal-content">
									<form x-on:submit.prevent="await putRecipe(formatRecipe(recipe)); $el.reset(); $store.recipes = await getRecipes();"
										  x-data="{recipe: {id: recipe.id, title: '', ingredients: '', instructions: '', categories:[]}, availablecategories: ''}"
										  x-init="availablecategories = await getCategories();">
										<div class="modal-header">
											<h5 class="modal-title">Modal title</h5>
											<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
										</div>
										<div class="modal-body">

											<div class="my-3 row">
												<label for="editRecipeTitle" class="col-2 col-form-label">Title</label>
												<div class="col-7">
													<input id="editRecipeTitle" x-model="recipe.title" class="form-control" />
												</div>
											</div>

											<div class="my-3 row">
												<label for="editRecipeIngredients" class="col-form-label col-2">Ingredients</label>
												<div class="col-7">
													<textarea class="form-control" x-model="recipe.ingredients" id="editRecipeIngredients" rows="5" placeholder="enter every ingredient on a separate line"></textarea>
												</div>
											</div>

											<div class="my-3 row">
												<label for="editRecipeInstructions" class="col-form-label col-2">Instructions</label>
												<div class="col-7">
													<textarea class="form-control" x-model="recipe.instructions" id="editRecipeInstructions" rows="5" placeholder="enter every instruction on a separate line"></textarea>
												</div>
											</div>

											<div class="my-3 row">
												<label for="editRecipeCategories" class="col-form-label col-2 ">Categories</label>
												<div class="col-7">
													<template x-for="category in availablecategories">
														<div>
															<input x-id="['category'+category]" type="checkbox" :value="category" x-model="recipe.categories">
															<label for="$id('category'+category)" x-text="category"></label>
															<br />
														</div>
													</template>
												</div>
											</div>
										</div>
										<div class="modal-footer">
											<button type="submit" class="btn btn-primary" data-bs-dismiss="modal">
												edit recipe
											</button>
										</div>
									</form>
								</div>
							</div>
						</div>

					</div>
				</div>
			</div>
		</template>
	</div>
</div>

<div x-show="tab=='categories'">
	<div class="container d-flex justify-content-between align-items-center my-4">
		<h2>All Categories</h2>
		<button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createCategoryModal">
			Add a Category
		</button>
	</div>

	@* Category Cards *@
	<div class="row row-cols-auto justify-content-center g-4 mx-5"
		 x-data="{ categories: {}}"
		 x-effect="categories = await $store.categories;"
		 x-cloak>

		<template x-for="category in categories">
			<div class="col">
				<div class="card text-center">
					<div class="card-body">
						<h5 class="card-title" x-text="category"></h5>
						<div class="btn-group">
							<button class="btn btn-primary" data-bs-toggle="modal" :data-bs-target="'#editCategoryModal' + category">
								<i class="bi bi-pencil-square"></i>
							</button>
							<button class="btn btn-danger" data-bs-toggle="modal" :data-bs-target="'#deleteCategoryModal' + category">
								<i class="bi bi-trash"></i>
							</button>
						</div>
					</div>

					@* Edit Category Modal *@
					<div class="modal fade" :id="'editCategoryModal' + category" tabindex="-1" aria-labelledby="editCategoryModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form x-on:submit.prevent="await putCategory(oldCategory, editedCategory); $el.reset(); $store.categories = await getCategories();"
									  x-data="{oldCategory: category, editedCategory: ''}">
									<div class="modal-header">
										<h5 class="modal-title" id="editCategoryModalLabel">What is the new category name?</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<div class="my-3 row">
											<label for="editCategoryTitle" class="col-2 col-form-label">Title</label>
											<div class="col-10">
												<input id="editCategoryTitle" x-model="editedCategory" class="form-control" />
											</div>
										</div>
									</div>
									<div class="modal-footer">
										<button type="submit" class="btn btn-primary" data-bs-dismiss="modal">
											Edit Category
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>

					@* Delete Category Modal *@
					<div class="modal fade" :id="'deleteCategoryModal' + category" tabindex="-1" aria-labelledby="deleteCategoryModalLabel" aria-hidden="true">
						<div class="modal-dialog">
							<div class="modal-content">
								<form x-on:submit.prevent="await deleteCategory(category); $el.reset(); $store.categories = await getCategories();"
									  x-data="{category: category}">
									<div class="modal-header">
										<h5 class="modal-title" id="deleteCategoryModalLabel">Are you sure you want to delete this category?</h5>
										<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
									</div>
									<div class="modal-body">
										<dl class="row">
											<dt>
												Category
											</dt>
											<dd x-html="category">
											</dd>
										</dl>
									</div>
									<div class="modal-footer">
										<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
										<button type="submit" class="btn btn-danger" data-bs-dismiss="modal">
											Delete Category
										</button>
									</div>
								</form>
							</div>
						</div>
					</div>
				</div>
			</div>
		</template>

	</div>
</div>

<!-- Add Recipe Modal -->
<div class="modal fade" id="createRecipeModal" tabindex="-1" aria-labelledby="createRecipeModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<form x-on:submit.prevent="await postRecipe(formatRecipe(recipe)); $el.reset(); $store.recipes = await getRecipes();"
				  x-data="{recipe: {title: '', ingredients: '', instructions: '', categories:[]}, availablecategories: ''}"
				  x-init="availablecategories = await getCategories();">
				<div class="modal-header">
					<h5 class="modal-title" id="createRecipeModalLabel">What is the recipe like?</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">

					<div class="my-3 row">
						<label for="createRecipeTitle" class="col-2 col-form-label">Title</label>
						<div class="col-7">
							<input id="createRecipeTitle" x-model="recipe.title" class="form-control" />
						</div>
					</div>

					<div class="my-3 row">
						<label for="createRecipeIngredients" class="col-form-label col-2">Ingredients</label>
						<div class="col-7">
							<textarea class="form-control" x-model="recipe.ingredients" id="createRecipeIngredients" rows="5" placeholder="enter every ingredient on a separate line"></textarea>
						</div>
					</div>

					<div class="my-3 row">
						<label for="createRecipeInstructions" class="col-form-label col-2">Instructions</label>
						<div class="col-7">
							<textarea class="form-control" x-model="recipe.instructions" id="createRecipeInstructions" rows="5" placeholder="enter every instruction on a separate line"></textarea>
						</div>
					</div>

					<div class="my-3 row">
						<label for="createRecipeCategories" class="col-form-label col-2 ">Categories</label>
						<div class="col-7">
							<template x-for="category in availablecategories">
								<div>
									<input x-id="['category'+category]" type="checkbox" :value="category" x-model="recipe.categories">
									<label for="$id('category'+category)" x-text="category"></label>
									<br />
								</div>
							</template>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-primary" data-bs-dismiss="modal">
						Create recipe
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

@* Add Category Modal *@
<div class="modal fade" id="createCategoryModal" tabindex="-1" aria-labelledby="createCategoryModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<form x-on:submit.prevent="await postCategory(category); $el.reset(); $store.categories = await getCategories();"
				  x-data="{category: ''}">
				<div class="modal-header">
					<h5 class="modal-title" id="createCategoryModalLabel">What is the new category</h5>
					<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="my-3 row">
						<label for="createCategoryTitle" class="col-2 col-form-label">Title</label>
						<div class="col-10">
							<input id="createCategoryTitle" x-model="category" class="form-control" />
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="submit" class="btn btn-primary" data-bs-dismiss="modal">
						Create Category
					</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script type="text/javascript">
	document.addEventListener('alpine:init', () => {
		Alpine.store('recipes', getRecipes());
		Alpine.store('categories', getCategories());
	});

	const baseUrl = 'https://localhost:7131';

	async function getRecipes() {
		return fetch(new URL('/recipes', baseUrl).toString()).then(response => response.json());
	}

	async function getCategories() {
		return fetch(new URL('/categories', baseUrl).toString()).then(response => response.json());
	}

	function formatRecipe(recipe) {
		return {
			id: recipe.id,
			title: recipe.title,
			ingredients: recipe.ingredients.split('\n'),
			instructions: recipe.instructions.split('\n'),
			categories: recipe.categories
		};
	}

	async function postRecipe(recipe) {
		return fetch(new URL('/recipes', baseUrl).toString(), {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(recipe)
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}

	async function postCategory(category) {
		return fetch(new URL(`/categories?category=${category}`, baseUrl).toString(), {
			method: 'POST',
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}

	async function putRecipe(recipe) {
		return fetch(new URL(`/recipes/${recipe.id}`, baseUrl).toString(), {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json'
			},
			body: JSON.stringify(recipe)
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}

	async function putCategory(category, editedCategory) {
		return fetch(new URL(`/categories/${category}?editedcategory=${editedCategory}&`, baseUrl).toString(), {
			method: 'PUT',
			headers: {
				'Content-Type': 'application/json'
			}
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}

	async function deleteRecipe(recipe) {
		return fetch(new URL(`/recipes/${recipe.id}`, baseUrl).toString(), {
			method: 'DELETE'
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}

	async function deleteCategory(category) {
		return fetch(new URL(`/categories/${category}`, baseUrl).toString(), {
			method: 'DELETE'
		})
			.then(response =>
				response.json())
			.then(data => {
				console.log('Success:', data);
			})
			.catch((error) => {
				console.error('Error:', error);
			});
	}
</script>